<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Welcome to the web interface of DyCon Toolbox, the computational platform developed within the <a href='https://cmc.deusto.eus/dycon/' target='_blank'>ERC DyCon - Dynamic Control</a> project.">
	<link rel='shortcut icon' type='image/png' href='/DyCon-Blog/favicon.png' />

  <title>
    Optimal strategies for guidance-by-repulsion model with IpOpt and AMPL - DyCon Blog
    
  </title>

  <link rel="canonical" href="https://deustotech.github.io/DyCon-Blog/tutorial/wp06/P0005">

  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="https://deustotech.github.io/DyCon-Blog/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="https://deustotech.github.io/DyCon-Blog/css/clean-blog.css">

   <!-- Adjust Colors -->
  <link rel="stylesheet" href="https://deustotech.github.io/DyCon-Blog/colorscheme.css">

  <!-- Pygments Github CSS -->
  <link rel="stylesheet" href="https://deustotech.github.io/DyCon-Blog/css/syntax.css">


  <script src="https://deustotech.github.io/DyCon-Blog/lib/js/libgif.js "></script>
  <script src="https://deustotech.github.io/DyCon-Blog/lib/js/rubbable.js "></script>


  <!-- Google Fonts Raleway -->
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,700" rel="stylesheet">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
	<!-- MathJax -->
  <script type="text/x-mathjax-config">
	MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    },
		TeX: {
      equationNumbers: {
        autoNumber: "AMS"
      },
      extensions: ["AMSmath.js", "AMSsymbols.js"],
      Macros:{
        norm: ["|| #1 ||",1],
        abs: ["| #1 |",1],
        hdots: "...",
        RR: "\\mathbb{R}",
        ffl: ["(d_x^2)^{#1}",1],
        ccs: "c_{1,s}",
        kernel: ["|x-y|^{#1}",1],
        ue: ["#1^{\\epsilon}",1]
      }
    },
    CommonHTML: {
      styles: {
        "@font-face /* vec */ ": {
          "font-family": "MJX-VEC",
          src: [
            "url(data:application/x-font-woff;charset=utf-8;base64,",
            "d09GRgABAAAAAARMAA0AAAAABiQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAAEMAAAABwA",
            "AAAccRGLqUdERUYAAAQMAAAAJAAAACgANAAmT1MvMgAAAaAAAABJAAAAYFc5gfFjbWFwAAACAAAA",
            "AEYAAAFKQxjlbWdhc3AAAAQEAAAACAAAAAj//wADZ2x5ZgAAAlQAAACUAAAAlIQU9HBoZWFkAAAB",
            "MAAAADAAAAA2C748e2hoZWEAAAFgAAAAHgAAACQFXQDqaG10eAAAAewAAAAUAAAAFAYvAE9sb2Nh",
            "AAACSAAAAAwAAAAMACgAcm1heHAAAAGAAAAAHQAAACAASQAmbmFtZQAAAugAAADxAAAB5uwlD0hw",
            "b3N0AAAD3AAAACgAAAA34M9aEXjaY2BkYGAA4uOfgq7G89t8ZeBmfgEUYbga+icNTssClVxnOgXk",
            "cjAwgUQBdqEMW3jaY2BkYGBu+feBgYHxCwMQMF5nYGRABawAcaQESgAAeNpjYGRgYGBlUGZgYgAB",
            "EMnIABJzAPMZAAZZAHAAAAB42mNgYSxn/MLAysDA1MW0h4GBoQdCMz5gMGRkAooysDEzwAAjECvA",
            "OAFprikMBxgUFCcxt/z7wMDA3MIoAFUDAwoMjACD8Qv5AAAAAfQAMgAAAAABTQAAAPoAAAH0AB14",
            "2mNgYGBmgGAZBkYGEHAB8hjBfBYGDSDNBqQZGZgYFBQn/f8P5IPp/4/vFUHVAwEjGwOcw8gEJJgY",
            "UAEjxIrhDACLGwmnAAAAAAAUABQAFAAUAEoAAgAyAAABwgIVAAMABwAAMxEhESUhESEyAZD+ogEs",
            "/tQCFf3rMgGxAAEAHQIEAdcCygAiAAABNDYzMhcWFxYXFhUUBgcGBw4DIyImNTQ3IycmNTQ3ISYB",
            "eQsJBwUFBQofCwYLKyACBwMGBAcNL6urDQ0BZxgCtggMBQQPJRQHCwkGBhYpAgkCAgsJEygBCQoH",
            "DSYAeNqVjrGKwkAURe/EGBBUrG12CishMrFQcDuLsAi26YMOmsIMxAh+hN8i+CF+gd+y4B3zttjC",
            "woHhncu7774HoI8rFP5eIKzQw5dwgAjfwi2McBEO6bkLtzHAr3CEnhrTqcKOpDasMCQ1HKCLWLiF",
            "HyyFQ3puwm1oPIQjDFXfR62Ro8YeK9YzMlhsqB0qtvJ6v8rPmd3Uzkv2tihwwoHCbosTa0pryYH0",
            "NbKjRWPB/z626Se8dsY/hSHPGeTKOnXVzuqF/reYOoln8dQk80+u9b0KR97rD9Rc4xdNXtVQI7PV",
            "sXClNiaZGGP0B+FPMN1KMAAAAHjaY2BiAIP/zQxGDNgAKxAzMjAxMDMycSUWFeWXF2WmZ5QAAGh5",
            "BhgAAAAB//8AAnjaY2BkYGDgA2IJBgUgycTAyMDMwAIkWcA8BgZGCAYACgIAWwAAAAEAAAAAxmW3",
            "ygAAAADVVeemAAAAANVV7Dg=) format('woff')"
          ].join('')
        },
        ".MJX-VEC": {
          "font-family": "MJX-VEC"
        }
      }
    }
  });
  MathJax.Hub.Register.StartupHook("CommonHTML Jax Ready", function () {
    var MML = MathJax.ElementJax.mml;
    var fixCombiningChar = MML.mo.prototype.CHTMLfixCombiningChar;
    MML.mo.Augment({
      CHTMLfixCombiningChar: function (node) {
        if (node.textContent === '\u20D7') {
          //
          //  Safari makes combining characters into non-combining ones when
          //  they don't have anything to combine with; replace \vec arrow
          //  with a non-combining one so all browsers get the same thing
          //
          node = node.firstChild;
          node.firstChild.nodeValue = "\u2192";
          node.className = "mjx-char MJX-VEC";
          node.style.marginLeft = "-.5em";
          node.style.paddingTop = ".45em";
        } else {
          fixCombiningChar.call(this,node);
        }
      }
    });
  });
	</script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
	<!--<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js" type="text/javascript"></script>-->

    <!-- jQuery -->
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<!-- Custom Theme JavaScript -->
  <script src="https://deustotech.github.io/DyCon-Blog/js/clean-blog.min.js "></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-128123935-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-128123935-3');
  </script>
  <!-- End Google Analytics -->



  <!-- marKdown editor -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
  <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
</head>

<body>
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!-- <a class="navbar-brand" href="/DyCon-Blog/">
                 <img src="https://deustotech.github.io//DyCon-Blog//assets/logo_DyCon.png">
            </a> -->
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/DyCon-Blog/">Home</a>
                </li>
                
                
                    
                        
                    
                <li>
                    <a href="/DyCon-Blog/projects/posts">Documentation</a>
                </li>
                
                    
                <li>
                    <a href="/DyCon-Blog/projects/authors">Authors</a>
                </li>
                
                <li>
                        <a href="https://deustotech.github.io/DyCon-Blog/projects/search.byWP">Sitemap</a>
                </li>
                <li>
                        <a href="http://cmc.deusto.eus/">Chair of Computational Mathematics</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Post Header -->
<header class="intro-header">
  <div class="container" style="padding-top: 70px;">
    <div class="row">
      <div class="col-lg-10 col-md-10 col-md-offset-1">
        <div class="post-heading" style="padding: 0px 0"><h2><small class="light-grey"><a href="https://deustotech.github.io//DyCon-Blog/projects/posts">Work Packages</a>
            &#8827;<a href="https://deustotech.github.io//DyCon-Blog/workpackage/WP06">
            Finite versus infinite-dimensional dynamical systems</a> &#8827;</small>
          </h2>
          <h1>Optimal strategies for guidance-by-repulsion model with IpOpt and AMPL</h1>
					<p class="meta">
            <div class="post-preview-authors ellipsis-one-line">
              Author:
              
              
                
                <span style="text-decoration: none;" itemprop="author" itemscope itemtype="http://schema.org/Person">
                  <span itemprop="name">
                    <a style="text-decoration: none;" href="https://deustotech.github.io/DyCon-Blog/author/DongnamK">Dongnam Ko</a>
                  </span>
                </span>
              
              - 27 May 2019
            </div>
					</p>
        </div>
      </div>
		</div>
	</div>
</header>
<!-- Post Content -->
<style>
img {
	display:block;
	max-width:  100%;
	margin-left: auto;
	margin-right: auto;
}

@media only screen and (min-width: 1000px) {
img {
	-moz-transition:-moz-transform 0.5s ease-in; 
	-webkit-transition:-webkit-transform 0.5s ease-in; 
	-o-transition:-o-transform 0.5s ease-in;
}
img:active{
	-moz-transform:scale(1.2); 
	-webkit-transform:scale(1.2);
	-o-transform:scale(1.2);
}
}

@media only screen and (min-width: 1250px) {
img {
	-moz-transition:-moz-transform 0.5s ease-in; 
	-webkit-transition:-webkit-transform 0.5s ease-in; 
	-o-transition:-o-transform 0.5s ease-in;
}
img:active{
	-moz-transform:scale(1.5); 
	-webkit-transform:scale(1.5);
	-o-transform:scale(1.5);
}
}

@media only screen and (min-width: 1500px) {
img {
	-moz-transition:-moz-transform 0.5s ease-in; 
	-webkit-transition:-webkit-transform 0.5s ease-in; 
	-o-transition:-o-transform 0.5s ease-in;
}
img:active{
	-moz-transform:scale(2); 
	-webkit-transform:scale(2);
	-o-transform:scale(2);
}
}
</style>
<article>
  <div id="content" class="container">
    <div class="row">
      <div class="col-md-10 col-md-offset-1">
        
        <h3 id="a-sample-result">A sample result</h3>

<p><img src="https://deustotech.github.io/DyCon-Blog/assets/imgs/WP06/P0005/ds.gif" alt="Figure1" /></p>

<p>This video describes an optimal control steering red dots(evaders) to the position $(4,4)$, which is calculated by IpOpt with AMPL. See <a href="https://deustotech.github.io/DyCon-Blog/tutorial/wp03/P0002">the post explaining IpOpt and AMPL</a> for detailed description.</p>

<h3 id="the-guidance-by-repulsion-model">The guidance-by-repulsion model</h3>

<p>Let $u_{ei}$ and $u_{dj}$ be the positions of the evaders $(i=1,\ldots,N)$ and drivers $(j=1,\ldots,M)$, respectively, in ${\mathbb R}^2$. We consider the following ODE system:</p>

<script type="math/tex; mode=display">\ddot{u}_{dj} = -f_d(|u_{dj} - u_{ec}|)(u_{dj} - u_{ec}) - \nu \dot{u}_{dj} + \kappa_j(t) (u_{dj} - u_{ec})^\perp,\quad u_{ec} := \frac{1}{N}\sum_{k=1}^N u_{ek},</script>

<script type="math/tex; mode=display">\ddot{u}_{ei} =  - \frac{1}{M} \sum_{j=1}^M f_e(|u_{dj} - u_{ei}|)(u_{dj} - u_{ei}) - \nu \dot{u}_{ei}, \\</script>

<script type="math/tex; mode=display">u_{dj}(0) = u_{dj}^0,~ u_{ei}(0) = u_{ei}^0,~ \dot{u}_{dj}(0) = v_{dj}^0, ~ \dot{u}_{ei}(0) = v_{ei}^0,</script>

<p>where $\kappa_j(t)$ is the control interface and the interaction functions are given by</p>

<script type="math/tex; mode=display">f_d(r) = \frac{2}{r^2}-\frac{3}{r^4}+2,\quad f_e(r) = \frac{1}{r^2} \quad\text{and}\quad \nu = 2.</script>

<p>In the dynamics, the evaders always get forced from all of the drivers, while the drivers wants to keep a stable distance ($f_d(1)-f_e(1)=0$). By choosing proper $\kappa_j(t)$, we wants to steer the evaders into a predetermined region.</p>

<p>The objective of the control is given by the cost function with the fixed final time $t_f&gt;0$,</p>

<script type="math/tex; mode=display">J(\kappa_1(\cdot),\ldots,\kappa_M(\cdot)) = \frac{1}{N} \sum_{i=1}^N |u_{ei}(t_f) - u_f|^2 + \frac{\delta_1}{M} \sum_{k=1}^M \int_0^{t_f} |\kappa_k(t)|^2 dt,</script>

<p>where $\delta_1$ is a regularization coefficient, $0.1$ in this post.</p>

<h3 id="ampl-code-for-solving-the-optimal-control-problem">AMPL code for solving the optimal control problem</h3>

<p>Let us explain an AMPL code step by step. First, we need to set relative parameters.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># GBR_fixedtime.mod
</span>
<span class="c1"># This file solves the Guidance-by-repulsion model with 2 drivers and 16 evaders to 
</span>
<span class="c1"># the target point [4;4] in a fixed final time T=10.
</span>
<span class="c1"># Define the parameters of the problem
</span>
<span class="n">param</span> <span class="n">pi</span>      <span class="o">=</span> <span class="mf">3.141592653589793238462643</span><span class="p">;</span> 

<span class="n">param</span> <span class="n">Nt</span>      <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>      <span class="c1"># number of discretized points in time
</span>
<span class="n">param</span> <span class="n">M_sqrt</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>        <span class="c1"># sqrt of Number of evaders
</span>
<span class="n">param</span> <span class="n">M_e</span>     <span class="o">=</span> <span class="n">M_sqrt</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span> <span class="c1"># Number of evaders
</span>
<span class="n">param</span> <span class="n">M_d</span>     <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>        <span class="c1"># Number of drivers
</span>
<span class="n">param</span> <span class="n">T</span>       <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="n">param</span> <span class="n">M_kappa</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>        <span class="c1"># Bound on the control
</span>
<span class="c1"># Target point
</span>
<span class="n">param</span> <span class="n">uf1</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">param</span> <span class="n">uf2</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</code></pre></div></div>

<p>For the initial condition, we use uniform distribution of evaders in a square $[-1,1]\times[-1,1]$, and the drivers are in a circle with radius $5$.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Initial values
</span>
<span class="n">param</span> <span class="n">ue_zero</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">};</span>
<span class="k">for</span> <span class="p">{</span><span class="n">k1</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_sqrt</span><span class="p">,</span> <span class="n">k2</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_sqrt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">{</span>
	<span class="n">let</span> <span class="n">ue_zero</span><span class="p">[</span><span class="n">M_sqrt</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">k2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span><span class="o">=</span> <span class="p">((</span><span class="n">k1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">M_sqrt</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">let</span> <span class="n">ue_zero</span><span class="p">[</span><span class="n">M_sqrt</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">k2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span><span class="o">=</span> <span class="p">((</span><span class="n">k2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">M_sqrt</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">param</span> <span class="n">ud_zero</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">};</span>
<span class="k">for</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">{</span>
	<span class="n">let</span> <span class="n">ud_zero</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span><span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">M_d</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">let</span> <span class="n">ud_zero</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span><span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">M_d</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1"># State variables
</span>
<span class="n">var</span> <span class="n">ue</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">};</span>
<span class="n">var</span> <span class="n">ve</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">};</span>
<span class="n">var</span> <span class="n">ud</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">};</span>
<span class="n">var</span> <span class="n">vd</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">};</span>
<span class="n">var</span> <span class="n">uec</span> <span class="p">{</span><span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">M_e</span><span class="o">*</span><span class="p">(</span><span class="nb">sum</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">}</span> <span class="p">(</span><span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]));</span>

<span class="c1"># initialize
</span>
<span class="n">subject</span> <span class="n">to</span> <span class="n">ue_init</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">:</span> <span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ue_zero</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">];</span>
<span class="n">subject</span> <span class="n">to</span> <span class="n">ud_init</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">:</span> <span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ud_zero</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">j</span><span class="p">];</span>
<span class="n">subject</span> <span class="n">to</span> <span class="n">vd_init</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">:</span> <span class="n">ve</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">subject</span> <span class="n">to</span> <span class="n">ve_init</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">:</span> <span class="n">vd</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
<span class="n">let</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span><span class="o">=</span> <span class="n">ue_zero</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">];</span>
<span class="n">let</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span><span class="o">=</span> <span class="n">ud_zero</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">j</span><span class="p">];</span>
<span class="n">let</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="n">ve</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">let</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="n">vd</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   
</code></pre></div></div>
<p>For the initial guess, we also put the initial data for the whole timeline. If we don’t specify this, then the default values are zero, which can make redundant errors or iterations.</p>

<p>Now, we define the controls and cost.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The control function
</span>
<span class="n">var</span> <span class="n">kappa</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">},</span> <span class="n">default</span> <span class="mf">2.8</span><span class="p">;</span>  
<span class="n">subject</span> <span class="n">to</span> <span class="n">kappa_bounds</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">}</span> <span class="p">:</span> <span class="o">-</span><span class="n">M_kappa</span> <span class="o">&lt;=</span> <span class="n">kappa</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">M_kappa</span><span class="p">;</span>
<span class="c1"># initial guess on control
</span>
<span class="n">let</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">}</span> <span class="n">kappa</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span><span class="o">=</span> <span class="mf">2.8</span><span class="p">;</span>

<span class="c1"># The cost function
</span>
<span class="n">minimize</span> <span class="n">cost</span><span class="p">:</span> 
 <span class="mi">1</span><span class="o">/</span><span class="n">M_e</span><span class="o">*</span><span class="p">(</span><span class="nb">sum</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">}</span> <span class="p">((</span><span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">uf1</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">uf2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">/</span><span class="n">M_d</span><span class="o">/</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span> <span class="nb">sum</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">}</span> <span class="p">((</span> <span class="n">kappa</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span><span class="p">))</span> <span class="p">);</span>
</code></pre></div></div>
<p>The dynamics need to be described in the form of restriction condition of states and control variables. In order to avoid divide-by-zero, we additionally put the restriction on the distance. Since our equation has unbounded interaction kernels, it is convenient to use Euler’s forward method. Backward or central method may result unexpected high velocities by closing to the infinite values.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Restriction on distance
</span>
<span class="n">subject</span> <span class="n">to</span> <span class="n">distance</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">}</span> <span class="p">:</span>
		<span class="p">(</span><span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="mf">0.001</span><span class="p">;</span>
<span class="c1"># Dynamics
</span>
<span class="n">subject</span> <span class="n">to</span> <span class="n">ue_dyn</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">:</span>
		<span class="p">(</span><span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">Nt</span><span class="o">/</span><span class="n">T</span> <span class="o">=</span> <span class="n">ve</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">];</span>
<span class="n">subject</span> <span class="n">to</span> <span class="n">ud_dyn</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">:</span>
		<span class="p">(</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">Nt</span><span class="o">/</span><span class="n">T</span> <span class="o">=</span> <span class="n">vd</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">];</span>
<span class="n">subject</span> <span class="n">to</span> <span class="n">ve_dyn</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">:</span>
		<span class="p">(</span><span class="n">ve</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">ve</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">Nt</span><span class="o">/</span><span class="n">T</span> <span class="o">=</span> <span class="nb">sum</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">}</span> <span class="p">(</span> <span class="o">-</span><span class="mi">2</span><span class="o">/</span><span class="p">((</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="p">)</span>  <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">ve</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">];</span>
<span class="n">subject</span> <span class="n">to</span> <span class="n">vd1_dyn</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">:</span>
		<span class="p">(</span><span class="n">vd</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">vd</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">Nt</span><span class="o">/</span><span class="n">T</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">5.5</span><span class="o">/</span><span class="p">((</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">uec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">uec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">10</span><span class="o">/</span><span class="p">(((</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">uec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">uec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">uec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">kappa</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">uec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">vd</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span>
<span class="n">subject</span> <span class="n">to</span> <span class="n">vd2_dyn</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">:</span>
		<span class="p">(</span><span class="n">vd</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">vd</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">Nt</span><span class="o">/</span><span class="n">T</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">5.5</span><span class="o">/</span><span class="p">((</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">uec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">uec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">10</span><span class="o">/</span><span class="p">(((</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">uec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">uec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">uec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">kappa</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">uec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">vd</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">];</span>
</code></pre></div></div>
<p>The next step is to solve and get the output. It is convenient to describe the parameters of the problem to visualize later.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Solve with IpOpt
</span>
<span class="n">option</span> <span class="n">solver</span> <span class="n">ipopt</span><span class="p">;</span>
<span class="n">option</span> <span class="n">ipopt_options</span> <span class="s">"max_iter=20000 linear_solver=mumps hessian_approximation=limited-memory halt_on_ampl_error yes"</span><span class="p">;</span>
<span class="n">solve</span><span class="p">;</span>
<span class="c1"># Display solution
</span>
<span class="n">printf</span> <span class="p">:</span> <span class="s">"</span><span class="si">%24.16</span><span class="s">e</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">T</span><span class="p">;</span>
<span class="n">printf</span> <span class="p">:</span> <span class="s">"</span><span class="si">%</span><span class="s">d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Nt</span><span class="p">;</span>
<span class="n">printf</span> <span class="p">:</span> <span class="s">"</span><span class="si">%</span><span class="s">d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">M_d</span><span class="p">;</span>
<span class="n">printf</span> <span class="p">:</span> <span class="s">"</span><span class="si">%</span><span class="s">d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">M_e</span><span class="p">;</span>
<span class="n">printf</span> <span class="p">:</span> <span class="s">"</span><span class="si">%24.16</span><span class="s">e</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">uf1</span><span class="p">;</span>
<span class="n">printf</span> <span class="p">:</span> <span class="s">"</span><span class="si">%24.16</span><span class="s">e</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">uf2</span><span class="p">;</span>

<span class="n">printf</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">}</span> <span class="p">:</span> <span class="s">"</span><span class="si">%24.16</span><span class="s">e</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">kappa</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">];</span>
<span class="n">printf</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">:</span> <span class="s">"</span><span class="si">%24.16</span><span class="s">e</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">];</span>
<span class="n">printf</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">:</span> <span class="s">"</span><span class="si">%24.16</span><span class="s">e</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ud</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">];</span>
<span class="n">printf</span> <span class="p">{</span><span class="n">k</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_e</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">:</span> <span class="s">"</span><span class="si">%24.16</span><span class="s">e</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ve</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">];</span>
<span class="n">printf</span> <span class="p">{</span><span class="n">l</span> <span class="ow">in</span> <span class="mf">1.</span><span class="o">.</span><span class="n">M_d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="mf">1..2</span><span class="p">}</span> <span class="p">:</span> <span class="s">"</span><span class="si">%24.16</span><span class="s">e</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">vd</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">];</span>
<span class="n">printf</span> <span class="p">:</span> <span class="s">"End. </span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<span class="n">end</span><span class="p">;</span>

</code></pre></div></div>

<p>Finally, we used MATLAB to show the trajectories. After copying the result to a file ‘output.txt’, we read it with the following code.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fid</span><span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s1">'output.txt'</span><span class="p">,</span><span class="s1">'r'</span><span class="p">);</span>            <span class="c1">% Open out.txt</span>
<span class="n">temp</span> <span class="o">=</span> <span class="nb">fscanf</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span><span class="s1">'%f'</span><span class="p">);</span>
<span class="n">M_d</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">M_e</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="n">index1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">index1</span><span class="p">);</span> <span class="n">index1</span> <span class="o">=</span> <span class="n">index1</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="n">Nt</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">index1</span><span class="p">);</span> <span class="n">index1</span> <span class="o">=</span> <span class="n">index1</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="n">M_d</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">index1</span><span class="p">);</span> <span class="n">index1</span> <span class="o">=</span> <span class="n">index1</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="n">M_e</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">index1</span><span class="p">);</span> <span class="n">index1</span> <span class="o">=</span> <span class="n">index1</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="n">uf1</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">index1</span><span class="p">);</span> <span class="n">index1</span> <span class="o">=</span> <span class="n">index1</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="n">uf2</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">index1</span><span class="p">);</span> <span class="n">index1</span> <span class="o">=</span> <span class="n">index1</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">index2</span> <span class="o">=</span> <span class="n">index1</span><span class="o">+</span><span class="n">M_d</span><span class="o">*</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">kappa</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">index1</span><span class="p">:</span><span class="n">index2</span><span class="p">);</span> <span class="n">kappa</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="p">[</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span> <span class="n">M_d</span><span class="p">]);</span> <span class="n">index1</span> <span class="o">=</span> <span class="n">index2</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">index2</span> <span class="o">=</span> <span class="n">index1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">M_e</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ue</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">index1</span><span class="p">:</span><span class="n">index2</span><span class="p">);</span> <span class="n">ue</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">ue</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span> <span class="n">M_e</span><span class="p">]);</span> <span class="n">index1</span> <span class="o">=</span> <span class="n">index2</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">index2</span> <span class="o">=</span> <span class="n">index1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">M_d</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ud</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">index1</span><span class="p">:</span><span class="n">index2</span><span class="p">);</span> <span class="n">ud</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span> <span class="n">M_d</span><span class="p">]);</span> <span class="n">index1</span> <span class="o">=</span> <span class="n">index2</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">index2</span> <span class="o">=</span> <span class="n">index1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">M_e</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ve</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">index1</span><span class="p">:</span><span class="n">index2</span><span class="p">);</span> <span class="n">ve</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">ve</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span> <span class="n">M_e</span><span class="p">]);</span> <span class="n">index1</span> <span class="o">=</span> <span class="n">index2</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">index2</span> <span class="o">=</span> <span class="n">index1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">M_d</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">vd</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">index1</span><span class="p">:</span><span class="n">index2</span><span class="p">);</span> <span class="n">vd</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">vd</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span> <span class="n">M_d</span><span class="p">]);</span> 
<span class="n">index2</span> <span class="o">==</span> <span class="nb">length</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>      <span class="c1">% Check the file is properly read.</span>
<span class="n">tline</span> <span class="o">=</span> <span class="nb">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

<span class="nb">fclose</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">%% Cost calculation</span>

<span class="n">u_f</span> <span class="o">=</span> <span class="p">[</span><span class="n">uf1</span><span class="p">;</span><span class="n">uf2</span><span class="p">];</span>
<span class="n">Final_Time</span> <span class="o">=</span> <span class="n">tline</span><span class="p">(</span><span class="k">end</span><span class="p">);</span>
<span class="n">Final_Position</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">ue</span><span class="p">(:,</span><span class="k">end</span><span class="p">,:),[</span><span class="mi">2</span> <span class="n">M_e</span><span class="p">]);</span>
<span class="n">Final_cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">Final_Position</span><span class="p">(</span><span class="mi">1</span><span class="p">,:)</span> <span class="o">-</span> <span class="n">u_f</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.^</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">Final_Position</span><span class="p">(</span><span class="mi">2</span><span class="p">,:)</span> <span class="o">-</span> <span class="n">u_f</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.^</span><span class="mi">2</span> <span class="p">)/</span><span class="n">M_e</span><span class="p">;</span>
<span class="n">Running_cost</span> <span class="o">=</span> <span class="mf">0.001</span><span class="o">*</span><span class="nb">trapz</span><span class="p">(</span><span class="n">tline</span><span class="p">,</span><span class="nb">mean</span><span class="p">(</span><span class="n">kappa</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">M_d</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))/</span><span class="n">M_d</span><span class="p">;</span>

<span class="c1">%% Visualize the trajectories</span>

<span class="n">f1</span> <span class="o">=</span> <span class="nb">figure</span><span class="p">(</span><span class="s1">'position'</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">400</span><span class="p">]);</span>
<span class="nb">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">hold</span> <span class="n">on</span>
<span class="k">for</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">M_d</span>
	<span class="nb">plot</span><span class="p">(</span><span class="n">ud</span><span class="p">(</span><span class="mi">1</span><span class="p">,:,</span><span class="n">k</span><span class="p">),</span><span class="n">ud</span><span class="p">(</span><span class="mi">2</span><span class="p">,:,</span><span class="n">k</span><span class="p">),</span><span class="s1">'b--'</span><span class="p">,</span><span class="s1">'LineWidth'</span><span class="p">,</span><span class="mf">1.3</span><span class="p">);</span>
<span class="k">end</span>
<span class="k">for</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">M_e</span>
	<span class="nb">plot</span><span class="p">(</span><span class="n">ue</span><span class="p">(</span><span class="mi">1</span><span class="p">,:,</span><span class="n">l</span><span class="p">),</span><span class="n">ue</span><span class="p">(</span><span class="mi">2</span><span class="p">,:,</span><span class="n">l</span><span class="p">),</span><span class="s1">'r-'</span><span class="p">,</span><span class="s1">'LineWidth'</span><span class="p">,</span><span class="mf">1.5</span><span class="p">);</span>
<span class="k">end</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'abscissa'</span><span class="p">)</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s1">'ordinate'</span><span class="p">)</span>
<span class="nb">title</span><span class="p">([</span><span class="s1">'Position error = '</span><span class="p">,</span> <span class="nb">num2str</span><span class="p">(</span><span class="n">Final_cost</span><span class="p">)])</span>
<span class="nb">grid</span> <span class="n">on</span>
</code></pre></div></div>

<p>Then, one can get the following trajectories and optimal control solution.</p>

<p><img src="https://deustotech.github.io/DyCon-Blog/assets/imgs/WP06/P0005/D2E16_figure.png" alt="Figure1" /></p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">plot</span><span class="p">(</span><span class="n">tline</span><span class="p">,</span><span class="n">kappa</span><span class="s1">','</span><span class="n">LineWidth</span><span class="o">'</span><span class="p">,</span><span class="mf">1.3</span><span class="p">);</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'Time'</span><span class="p">)</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s1">'Control \kappa(t)'</span><span class="p">)</span>
<span class="nb">title</span><span class="p">([</span><span class="s1">'Total Time = '</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">tline</span><span class="p">(</span><span class="k">end</span><span class="p">)),</span><span class="s1">' and running cost = '</span><span class="p">,</span><span class="nb">num2str</span><span class="p">(</span><span class="n">Running_cost</span><span class="p">)])</span>
<span class="nb">grid</span> <span class="n">on</span>
</code></pre></div></div>

<p><img src="https://deustotech.github.io/DyCon-Blog/assets/imgs/WP06/P0005/D2E16_control.png" alt="Figure2" /></p>

        <hr>
      </div>
    </div>
  </div>
</article>
<hr>

    <!-- Footer -->
<footer>
  <hr>
  <div class="container">
    <div class="row">
      <ul class="list-inline text-center">
        <li style="margin-right: 50px;">
          <img style="width: 250px;" src="/DyCon-Blog/img/logos/logo_DyCon.png " alt="">
        </li>
        <li style="padding-bottom: 5px;">
          <img style="width: 230px;" src="/DyCon-Blog/img/logos/logo_CCM_subDerecha_v002.png " alt="">
        </li>
      </ul>
    </div>
  </div>
</footer>

</body>
</html>
