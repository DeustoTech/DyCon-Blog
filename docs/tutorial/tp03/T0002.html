<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Welcome to the web interface of DyCon Toolbox, the computational platform developed within the <a href='https://cmc.deusto.eus/dycon/' target='_blank'>ERC DyCon - Dynamic Control</a> project.">



	<link rel='shortcut icon' type='image/png' href='/DyConBlog/favicon.png' />

    <title>Average Control by Stochastic Gradient method - DyCon Blog</title>

    <link rel="canonical" href="https://DeustoTech.github.io/DyConBlog/tutorial/tp03/T0002">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://DeustoTech.github.io/DyConBlog/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://DeustoTech.github.io/DyConBlog/css/clean-blog.css">

	<!-- Adjust Colors -->
    <link rel="stylesheet" href="https://DeustoTech.github.io/DyConBlog/colorscheme.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="https://DeustoTech.github.io/DyConBlog/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
  	<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
  	<link href="https://fonts.googleapis.com/css?family=Lusitana" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
	<!-- Math Jax -->
	<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']]
    },
		TeX: {
      equationNumbers: {
        autoNumber: "AMS"
      }
    },
    /*CommonHTML: {
      scale: 300
    }*/
	});
	</script>

	<!--<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js" type="text/javascript"></script>-->

    <!-- jQuery -->
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<!-- Custom Theme JavaScript -->
    <script src="https://DeustoTech.github.io/DyConBlog/js/clean-blog.min.js "></script>
    
 	<!-- 404  JavaScript -->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/DyConBlog/">
                 <img src="https://DeustoTech.github.io//DyConBlog/assets/logo_DyConToolbox_v001.png" >
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/DyConBlog/">Home</a>
                </li>
                
                
                <li>
                    <a href="/DyConBlog/projects/about">About</a>
                </li>
                
                
                
                <li>
                    <a href="/DyConBlog/projects/posts">Posts</a>
                </li>
                
                
                
                <li>
                    <a href="/DyConBlog/projects/search">Search</a>
                </li>
                
                
                
                <li>
                        <a href="http://cmc.deusto.eus/">Chair of Computational Mathematics</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header">
    <div class="container" style="padding-top: 70px;">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading" style="padding: 0px 0"><h2><small>MATLAB tutorial of <a href="https://DeustoTech.github.io//DyConBlog/topic/Tp03"></a> :</small></h2>
                    <h1>Average Control by Stochastic Gradient method</h1>

					<span class="meta">Posted by:
					
						• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name"><a href="https://DeustoTech.github.io/DyConBlog/author/AnaN">Ana Navarro</a></span></span>
					
						• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name"><a href="https://DeustoTech.github.io/DyConBlog/author/EnriqueZ">Enrique Zuazua</a></span></span>
					
					</span>
					<div class="shadowbox">
						<p>To start this tutorial, write the following command in the MATLAB console
							<pre class="highlight"><code><span class="nb">open average_control_by_stoch_gradient_step</span></code></pre>
						</p>
					</div>


                </div>
            </div>
		</div>


	</div>
</header>


<!-- Post Content -->
<style>
img {
	display:block;
	max-width:  100%;
	margin-left: auto;
	margin-right: auto;
}

@media only screen and (min-width: 1000px) {
img {
	-moz-transition:-moz-transform 0.5s ease-in; 
	-webkit-transition:-webkit-transform 0.5s ease-in; 
	-o-transition:-o-transform 0.5s ease-in;
}
img:active{
	-moz-transform:scale(1.2); 
	-webkit-transform:scale(1.2);
	-o-transform:scale(1.2);
}
}

@media only screen and (min-width: 1250px) {
img {
	-moz-transition:-moz-transform 0.5s ease-in; 
	-webkit-transition:-webkit-transform 0.5s ease-in; 
	-o-transition:-o-transform 0.5s ease-in;
}
img:active{
	-moz-transform:scale(1.5); 
	-webkit-transform:scale(1.5);
	-o-transform:scale(1.5);
}
}

@media only screen and (min-width: 1500px) {
img {
	-moz-transition:-moz-transform 0.5s ease-in; 
	-webkit-transition:-webkit-transform 0.5s ease-in; 
	-o-transition:-o-transform 0.5s ease-in;
}
img:active{
	-moz-transform:scale(2); 
	-webkit-transform:scale(2);
	-o-transform:scale(2);
}
}
</style>

<article>
    <div id="content" class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p>In the previous <a href="https://DeustoTech.github.io/DyConBlog/tutorial/tp03/T0002">work</a>, the concept of averaged control <sup id="fnref:fn"><a href="#fn:fn" class="footnote">1</a></sup> of parameter-dependent systems is introduced. The optimal control of the following functional is obtained applying the classical gradient descent algorithm</p>

<script type="math/tex; mode=display">\begin{equation*} \min_{u \in L^2(0,T)} \mathcal{J}\left( u\right) = \min_{u \in L^2(0,T)} \frac{1}{2} \left[ \frac{1}{\vert\mathcal{K}\vert} \sum_{\nu \in \mathcal{K}} x \left( T, \nu \right) - \bar{x} \right]^2  + \frac{\beta}{2} \int_0^T u^2 \mathrm{d}t, \quad \beta \in \mathbb{R}^+ \end{equation*}</script>

<p>Subject to the finite dimensional linear control system</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}  \left\{ \begin{array}{ll} x^\prime \left( t \right) = A \left( \nu \right) x \left( t \right) + B \left( \nu \right) u \left( t \right), \quad 0 < t <T, \\ x\left( 0 \right) = x^0. \end{array} \right. \end{align*} %]]></script>

<p>In this tutorial the main goal is to apply the stochastic gradient descent method to obtain the minimun of the same optimal control problem.</p>

<p>In this case, the iterative method is defined as</p>

<script type="math/tex; mode=display">\begin{equation*} u^{\left( k+1 \right)} = u^{\left( k \right)} - \gamma \left( \beta u^{\left( k \right)}- B^{\top}p \left( t,\nu_{i_k} \right) \right), \end{equation*}</script>

<p>where $p \left( t,\nu_{i_k} \right)$ is solution of the following adjoint problem</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*} \left\{ \begin{array}{ll} p^\prime \left( t, \nu \right) = -A \left( \nu \right) p \left( t,\nu \right), \quad 0 < t <T, \\ \displaystyle p\left( T \right) = - \left[ \frac{1}{\vert\mathcal{K}\vert} \sum_{\nu \in \mathcal{K}} x \left( T, \nu \right) - \bar{x} \right]. \end{array} \right. \end{align*} %]]></script>

<p>The values of parameter $\nu_i$ are</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">5</span><span class="p">;</span>
</code></pre></div></div>

<p>And save in K, the number of values</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">K</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">nu</span><span class="p">);</span>
</code></pre></div></div>

<p>We can, define the initial state of all ODE’s</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">N</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">%% dimension of vector state</span>
<span class="n">x0</span> <span class="o">=</span> <span class="nb">ones</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<p>We take as final target</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xt</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">;</span><span class="mi">0</span><span class="p">];</span>
</code></pre></div></div>

<p>Also, we need to define a initial control, that will be evolve</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span>
<span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">T</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">span</span> <span class="o">=</span> <span class="p">(</span><span class="n">t0</span><span class="p">:</span><span class="n">dt</span><span class="p">:</span><span class="n">T</span><span class="p">);</span>
<span class="c1">%%</span>
<span class="n">u0</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">span</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<p>Moreover, we can define the matrix A’s and B’s, that determine the linear system</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Am</span> <span class="o">=</span> <span class="o">-</span><span class="nb">triu</span><span class="p">(</span><span class="nb">ones</span><span class="p">(</span><span class="n">N</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Bm</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">Bm</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">A</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">K</span><span class="p">);</span>
<span class="n">B</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">K</span><span class="p">);</span>
<span class="k">for</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">K</span>
    <span class="n">A</span><span class="p">(:,:,</span><span class="n">index</span><span class="p">)</span> <span class="o">=</span> <span class="n">Am</span> <span class="o">+</span> <span class="p">(</span><span class="n">nu</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span><span class="o">*</span><span class="nb">diag</span><span class="p">(</span><span class="nb">diag</span><span class="p">(</span><span class="n">Am</span><span class="p">));</span>
    <span class="n">B</span><span class="p">(:,:,</span><span class="n">index</span><span class="p">)</span> <span class="o">=</span> <span class="n">Bm</span><span class="p">;</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Then, we solve the problem applying the stochastic gradient descent algorithm</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AverageProblemSG</span> <span class="o">=</span> <span class="n">ControlParameterDependent</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">u0</span><span class="p">,</span><span class="n">span</span><span class="p">);</span>
<span class="n">AverageStochasticGradient</span><span class="p">(</span><span class="n">AverageProblemSG</span><span class="p">,</span><span class="n">xt</span><span class="p">)</span>
<span class="nb">plot</span><span class="p">(</span><span class="n">AverageProblemSG</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://DeustoTech.github.io//DyConBlog/assets/imgs/TP03/T0002/copiaRM_01.png" alt="" /></p>

<p>Notice that, it is know that the SGD converges in mean <sup id="fnref:fn1"><a href="#fn:fn1" class="footnote">2</a></sup>. Hence, with only one trail of the stochastic algorithm it is possible do not have convergence. To see the convergence it is necessary to run the iterative method different times and to do the mean of all the trayectories</p>

<p>We define the number of trails of the stochastic method, as well as the maximum number of iterations, the tolerance and other auxiliar quantities.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">trails</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="n">MaxIter</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="n">Tol</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AverageProblemSG</span> <span class="o">=</span> <span class="n">ControlParameterDependent</span><span class="o">.</span><span class="nb">empty</span><span class="p">;</span>
<span class="n">J_executionsSG</span> <span class="o">=</span> <span class="p">{};</span>
<span class="n">error_executionsSG</span> <span class="o">=</span> <span class="p">{};</span>
<span class="n">index_trail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div>

<p>Now, the main problem is solved for each trail</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="n">index_trail</span> <span class="o">&lt;</span> <span class="n">trails</span>

    <span class="n">index_trail</span> <span class="o">=</span> <span class="n">index_trail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">%% Save the object in array</span>
    <span class="n">AverageProblemSG</span><span class="p">(</span><span class="n">index_trail</span><span class="p">)</span> <span class="o">=</span> <span class="n">ControlParameterDependent</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">u0</span><span class="p">,</span><span class="n">span</span><span class="p">);</span>
    <span class="n">AverageStochasticGradient</span><span class="p">(</span><span class="n">AverageProblemSG</span><span class="p">(</span><span class="n">index_trail</span><span class="p">),</span><span class="n">xt</span><span class="p">,</span><span class="s1">'MaxIter'</span><span class="p">,</span><span class="n">MaxIter</span><span class="p">,</span><span class="s1">'tol'</span><span class="p">,</span><span class="n">Tol</span><span class="p">)</span>
    <span class="n">addtaSG</span> <span class="o">=</span> <span class="p">[</span><span class="n">AverageProblemSG</span><span class="p">(</span><span class="n">index_trail</span><span class="p">)</span><span class="o">.</span><span class="n">addata</span><span class="p">];</span>

    <span class="n">J</span> <span class="o">=</span> <span class="n">addtaSG</span><span class="o">.</span><span class="n">Jhistory</span><span class="p">;</span>
    <span class="n">J_executionsSG</span><span class="p">{</span><span class="n">index_trail</span><span class="p">}</span> <span class="o">=</span> <span class="n">J</span><span class="p">;</span>

    <span class="nb">error</span> <span class="o">=</span> <span class="n">addtaSG</span><span class="o">.</span><span class="n">error_history</span><span class="p">;</span>
    <span class="n">error_executionsSG</span><span class="p">{</span><span class="n">index_trail</span><span class="p">}</span> <span class="o">=</span> <span class="nb">error</span><span class="p">;</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Here, we plot the trails and the mean of all trayectories</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">figure</span>
<span class="k">for</span> <span class="nb">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="n">trails</span>
    <span class="nb">plot</span><span class="p">(</span> <span class="n">J_executionsSG</span><span class="p">{</span><span class="nb">i</span><span class="p">},</span><span class="s1">'color'</span><span class="p">,[</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.9</span><span class="p">])</span>
    <span class="nb">hold</span> <span class="n">on</span>
<span class="k">end</span>
<span class="nb">title</span><span class="p">(</span><span class="s1">'Cost Function'</span><span class="p">,</span><span class="s1">'interpreter'</span><span class="p">,</span><span class="s1">'latex'</span><span class="p">)</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'Epoch'</span><span class="p">,</span><span class="s1">'interpreter'</span><span class="p">,</span><span class="s1">'latex'</span><span class="p">)</span>
<span class="nb">plot</span><span class="p">(</span><span class="n">mean_null</span><span class="p">(</span><span class="n">J_executionsSG</span><span class="p">),</span><span class="s1">'r'</span><span class="p">,</span><span class="s1">'LineWidth'</span><span class="p">,</span><span class="mf">1.75</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://DeustoTech.github.io//DyConBlog/assets/imgs/TP03/T0002/copiaRM_02.png" alt="" /></p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">figure</span>
<span class="k">for</span> <span class="nb">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="n">trails</span>
    <span class="nb">plot</span><span class="p">(</span> <span class="n">error_executionsSG</span><span class="p">{</span><span class="nb">i</span><span class="p">},</span><span class="s1">'color'</span><span class="p">,[</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.9</span><span class="p">])</span>
    <span class="nb">hold</span> <span class="n">on</span>
<span class="k">end</span>
<span class="nb">title</span><span class="p">(</span><span class="s1">'Error'</span><span class="p">,</span><span class="s1">'interpreter'</span><span class="p">,</span><span class="s1">'latex'</span><span class="p">)</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'Epoch'</span><span class="p">,</span><span class="s1">'interpreter'</span><span class="p">,</span><span class="s1">'latex'</span><span class="p">)</span>
<span class="nb">plot</span><span class="p">(</span><span class="n">mean_null</span><span class="p">(</span><span class="n">error_executionsSG</span><span class="p">),</span><span class="s1">'r'</span><span class="p">,</span><span class="s1">'LineWidth'</span><span class="p">,</span><span class="mf">1.75</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://DeustoTech.github.io//DyConBlog/assets/imgs/TP03/T0002/copiaRM_03.png" alt="" /></p>

<p>We can observe the convergence of the trayectories</p>

<h2 id="references">References</h2>

<div class="footnotes">
  <ol>
    <li id="fn:fn">
      <p>E. Zuazua (2014), Averaged Control. Automatica, 50 (12), p. 3077-3087. <a href="#fnref:fn" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:fn1">
      <p>F. Bach and E. Moulines (2011), Non-asymptotic analysis of stochastic approximation algorithms for machine learning, Advances in Neural Information Processing Systems. <a href="#fnref:fn1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>


                <hr>

            </div>
        </div>
    </div>
</article>


<hr>


    <!-- Footer -->
<footer>
  <hr>
  <div class="container">
    <div class="row">
      <div class="col-md-10">
        <ul class="list-inline text-center">
          <li>
            <img style="width: 200px;" src="/DyConBlog/img/logos/logo_DyCon.png " alt="">
          </li>
          <li>
            <img style="width: 250px;" src="/DyConBlog/img/logos/logo_CCM_subDerecha_v002.png " alt="">
          </li>
        </ul>
      </div>
    </div>
  </div>
</footer>


</body>

</html>
