<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Welcome to the web interface of DyCon Toolbox, the computational platform developed within the <a href='https://cmc.deusto.eus/dycon/' target='_blank'>ERC DyCon - Dynamic Control</a> project.">
	<link rel='shortcut icon' type='image/png' href='/DyCon-Blog/favicon.png' />

  <title>Optimal control of a  graph evolving in discrete time - DyCon Blog</title>

  <link rel="canonical" href="https://deustotech.github.io/DyCon-Blog/tutorial/wp99/P0001">

  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="https://deustotech.github.io/DyCon-Blog/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="https://deustotech.github.io/DyCon-Blog/css/clean-blog.css">

   <!-- Adjust Colors -->
  <link rel="stylesheet" href="https://deustotech.github.io/DyCon-Blog/colorscheme.css">

  <!-- Pygments Github CSS -->
  <link rel="stylesheet" href="https://deustotech.github.io/DyCon-Blog/css/syntax.css">

  <!-- Google Fonts Raleway -->
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,700" rel="stylesheet">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
	<!-- MathJax -->
	<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    },
		TeX: {
            equationNumbers: {
                                autoNumber: "AMS"
            },
            extensions: ["AMSmath.js", "AMSsymbols.js"],
        Macros:{
            norm: ["|| #1 ||",1],
            abs: ["| #1 |",1],
            hdots: "...",
            RR: "\\mathbb{R}",
            ffl: ["(d_x^2)^{#1}",1],
            ccs: "c_{1,s}",
            kernel: ["|x-y|^{#1}",1],
            ue: ["#1^{\\epsilon}",1]
            }
        },
    /*CommonHTML: {
      scale: 300
    }*/
	});
	</script>

	<!--<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js" type="text/javascript"></script>-->

    <!-- jQuery -->
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<!-- Custom Theme JavaScript -->
    <script src="https://deustotech.github.io/DyCon-Blog/js/clean-blog.min.js "></script>

 	<!-- 404  JavaScript -->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!-- <a class="navbar-brand" href="/DyCon-Blog/">
                 <img src="https://deustotech.github.io//DyCon-Blog//assets/logo_DyCon.png">
            </a> -->
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/DyCon-Blog/">Home</a>
                </li>
                
                
                <li>
                    <a href="/DyCon-Blog/projects/posts">Posts</a>
                </li>
                
                
                
                <li>
                    <a href="/DyCon-Blog/projects/search">Search</a>
                </li>
                
                
                
                <li>
                        <a href="http://cmc.deusto.eus/">Chair of Computational Mathematics</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header">
    <div class="container" style="padding-top: 70px;">
        <div class="row">
            <div class="col-lg-10 col-md-10 col-md-offset-1">
                <div class="post-heading" style="padding: 0px 0"><h2><small>Post of <a href="https://deustotech.github.io//DyCon-Blog/workpackage/WP99">Other Topics</a> :</small></h2>
                    <h1>Optimal control of a  graph evolving in discrete time</h1>

					<span class="meta">Posted by:
					
						• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name"><a href="https://deustotech.github.io/DyCon-Blog/author/AlejandroC">Alejandro Cunillera</a></span></span>
					
					</span>
                </div>
            </div>
		</div>


	</div>
</header>


<!-- Post Content -->
<style>
img {
	display:block;
	max-width:  100%;
	margin-left: auto;
	margin-right: auto;
}

@media only screen and (min-width: 1000px) {
img {
	-moz-transition:-moz-transform 0.5s ease-in; 
	-webkit-transition:-webkit-transform 0.5s ease-in; 
	-o-transition:-o-transform 0.5s ease-in;
}
img:active{
	-moz-transform:scale(1.2); 
	-webkit-transform:scale(1.2);
	-o-transform:scale(1.2);
}
}

@media only screen and (min-width: 1250px) {
img {
	-moz-transition:-moz-transform 0.5s ease-in; 
	-webkit-transition:-webkit-transform 0.5s ease-in; 
	-o-transition:-o-transform 0.5s ease-in;
}
img:active{
	-moz-transform:scale(1.5); 
	-webkit-transform:scale(1.5);
	-o-transform:scale(1.5);
}
}

@media only screen and (min-width: 1500px) {
img {
	-moz-transition:-moz-transform 0.5s ease-in; 
	-webkit-transition:-webkit-transform 0.5s ease-in; 
	-o-transition:-o-transform 0.5s ease-in;
}
img:active{
	-moz-transform:scale(2); 
	-webkit-transform:scale(2);
	-o-transform:scale(2);
}
}
</style>

<article>
    <div id="content" class="container">
        <div class="row">
            <div class="col-lg-10  col-md-10 col-md-offset-1">
                
                    <p></p>
                    
                            <a href="https://deustotech.github.io/DyCon-Blog/assets/imgs/WP99/P0001/Optimal_control_Acunillera.zip""><i class="fa fa-download fa-lg"></i>Download Code</a>  
                    
                

				<p>In this tutorial we are going to show how to use MATLAB to control a discrete-time dynamical system that models the interactions between the nodes of a graph. The control policy will minimize a discrete linear quadratic regulator.</p>

<p>Let us consider a graph G that consists on $N$ nodes $x_i\in\mathbb{R}$, $i={1,2,…,N}$ that evolve in discrete time steps according to the following equation:</p>

<script type="math/tex; mode=display">x_i[k+1] = x_i[k] + \gamma\sum_{j\neq i}(x_j[k]-x_i[k]),\ k\in\mathbb{N}\cup \{0\},\ \forall i=1,2,...N \\ x_i[0] = x_{i,0},\ \forall i=1,2,...N</script>

<p>where $\gamma &gt; 0$ is a coupling parameter.</p>

<p>We can simplify this equation by using the Perron matrix $P$ of the graph, this matrix is defined as $P = I - \gamma L$, where $L$ is the Laplacian of the graph and $I$ is the identity matrix. Let $x$ be $[x_1,…,x_N]^T$, the vector of states of the nodes. Moreover, we may add a control</p>

<script type="math/tex; mode=display">\{u[k]\}_{k=0,1,...}, u\in\mathbb{R}^M, 1\leq M \leq N</script>

<p>to drive the states of the nodes to a desired state.</p>

<script type="math/tex; mode=display">x[k+1]=Px[k]+Bu[k] \\    y[k] = Cx[k]        \\    x[0] = x_0 = [x_{1,0},...,x_{N,0}]^T</script>

<p>were $B$ and $C$ are two fixed matrices and $y\in\mathbb{R}^S$ are the observed states of $1\leq S\leq N$ nodes.</p>

<p>We aim to design a control policy ${u[k]}_{k=0,1,…}$ such that minimizes the following functional $J(x,u)$ while stabilizing the system.</p>

<script type="math/tex; mode=display">J(x,u) = \sum_{k=0}^\infty\left(x[k]^TQx[k]+u[k]^TRu[k]\right)</script>

<p>where $Q$ and $R$ are semidefinite positive and definite positive matrices respectively. We can choose these two matrices in order to penalize aggressive or slow controls. To do so, we will use MATLAB’s control system toolbox.</p>

<p>Finally, we will add a reference term in the control so that we can drive the system into a desired state.</p>

<p>For instance, let us consider the coupling parameter</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">gamma</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
</code></pre></div></div>

<p>We define now a connected and bidirected graph G. Let E be the edges of the graph. We will define this set as a 2-column matrix and then we create the graph G.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">;</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">;</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">;</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">;</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">;</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">;</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">];</span>
<span class="n">E</span> <span class="o">=</span> <span class="nb">table</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="s1">'VariableNames'</span><span class="p">,{</span><span class="s1">'EndNodes'</span><span class="p">});</span>
<span class="n">G</span> <span class="o">=</span> <span class="nb">graph</span><span class="p">(</span><span class="n">E</span><span class="p">);</span>
</code></pre></div></div>

<p>This is our graph</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">plot</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">'LineWidth'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'EdgeColor'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">,</span> <span class="s1">'MarkerSize'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="nb">title</span><span class="p">(</span><span class="s1">'Graph representation'</span><span class="p">,</span> <span class="s1">'FontSize'</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://deustotech.github.io/DyCon-Blog/assets/imgs/WP99/P0001/copiaRM_01.png" alt="" /></p>

<p>N is the size of the graph, that is to say, the number of nodes.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">N</span> <span class="o">=</span> <span class="n">numnodes</span><span class="p">(</span><span class="n">G</span><span class="p">);</span>
</code></pre></div></div>

<p>We compute the number of neighbours of each node</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">connectivities</span> <span class="o">=</span> <span class="n">degree</span><span class="p">(</span><span class="n">G</span><span class="p">);</span>
</code></pre></div></div>

<p>We check whether the graph is connected or not, if not, we must choose a different graph.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">conncomp</span><span class="p">(</span><span class="n">G</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Generate a new graph'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this example the considered graph is connected.</p>

<p>We compute the Perron matrix of $G$.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">P</span> <span class="o">=</span> <span class="nb">eye</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="nb">gamma</span> <span class="o">*</span> <span class="n">laplacian</span><span class="p">(</span><span class="n">G</span><span class="p">);</span>
</code></pre></div></div>

<p>We can see that the system tends to reach a consensus, that is to say, if no control is applied to the system, it evolves to a steady state in which all the nodes have the same state.</p>

<p>We define the initial state $x_0$</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x_0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">'</span><span class="p">;</span>
</code></pre></div></div>

<p>The mean of $x_0$ is 3</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mean</span><span class="p">(</span><span class="n">x_0</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
ans =

     3


</code></pre></div></div>

<p>The states of the nodes will evolve to the mean of the states at the initial time. We let the system evolve for 150 iterations.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">itmax</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
<span class="n">x</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">itmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">x</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">x_0</span><span class="p">;</span>
<span class="k">for</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">itmax</span>
    <span class="n">x</span><span class="p">(:,</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="n">x</span><span class="p">(:,</span><span class="n">k</span><span class="p">);</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">clf</span>
<span class="nb">hold</span> <span class="n">on</span>
<span class="k">for</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">N</span>
    <span class="nb">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">itmax</span><span class="p">,</span><span class="n">x</span><span class="p">(</span><span class="n">k</span><span class="p">,:),</span><span class="s1">'LineWidth'</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>
<span class="nb">legend</span><span class="p">(</span><span class="s1">'Node 1'</span><span class="p">,</span><span class="s1">'Node 2'</span><span class="p">,</span><span class="s1">'Node 3'</span><span class="p">,</span><span class="s1">'Node 4'</span><span class="p">,</span><span class="s1">'Node 5'</span><span class="p">,</span><span class="s1">'Node 6'</span><span class="p">,</span><span class="s1">'Node 7'</span><span class="p">,</span><span class="s1">'Node 8'</span><span class="p">)</span>
<span class="nb">title</span><span class="p">(</span><span class="s1">'Graph evolution without control'</span><span class="p">,</span><span class="s1">'FontSize'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'Iterations'</span><span class="p">,</span><span class="s1">'FontSize'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s1">'States of the nodes'</span><span class="p">,</span><span class="s1">'FontSize'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://deustotech.github.io/DyCon-Blog/assets/imgs/WP99/P0001/copiaRM_02.png" alt="" /></p>

<p>As stated before, we can see in this figure that the system naturally reaches consensus.</p>

<p>Recall that the system dynamics can be written as</p>

<script type="math/tex; mode=display">x[k+1] = Px[k]+Bu[k] \\    y[k] = Cx[k]</script>

<p>for any $k =0,1,…$.</p>

<p>We want to find a control $u$ such that the system stabilizes to the zero state.</p>

<p>We proceed to define matrices B and C:</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">B</span> <span class="o">=</span> <span class="nb">eye</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
<span class="n">C</span> <span class="o">=</span> <span class="nb">eye</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
<span class="c1">%% We can check whether the system is controllable</span>
<span class="k">if</span> <span class="nb">rank</span><span class="p">(</span><span class="n">ctrb</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">B</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">N</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'it is not controllable!'</span><span class="p">)</span>
<span class="k">end</span>
<span class="c1">%% In this case, it is controllable.</span>
</code></pre></div></div>

<p>We choose the matrices $Q$ and $R$ by using Bryson and Ho’s criterium.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Q_diag</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_0</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
<span class="n">R_diag</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">/</span> <span class="mi">5</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
<span class="n">Q</span> <span class="o">=</span> <span class="nb">diag</span><span class="p">(</span><span class="n">Q_diag</span><span class="p">);</span>
<span class="n">R</span> <span class="o">=</span> <span class="nb">diag</span><span class="p">(</span><span class="n">R_diag</span><span class="p">);</span>
</code></pre></div></div>

<p>We can use now the function dlqr (discrete linear quadratic regulator) to find the feedback control $u = -K_{f} x[k]$ that minimizes the functional $J(x,u)$.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Kf</span><span class="p">,</span> <span class="o">~</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlqr</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="p">);</span>
</code></pre></div></div>

<p>Now we can stabilize the system by using the feedback control that we have just computed</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">itmax</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">x</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">itmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">x</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">x_0</span><span class="p">;</span>
<span class="k">for</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">itmax</span>
    <span class="n">x</span><span class="p">(:,</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Kf</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="p">(:,</span><span class="n">k</span><span class="p">);</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">clf</span>
<span class="nb">hold</span> <span class="n">on</span>

<span class="k">for</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">N</span>
    <span class="nb">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">itmax</span><span class="p">,</span><span class="n">x</span><span class="p">(</span><span class="n">k</span><span class="p">,:),</span><span class="s1">'LineWidth'</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>
<span class="nb">legend</span><span class="p">(</span><span class="s1">'Node 1'</span><span class="p">,</span><span class="s1">'Node 2'</span><span class="p">,</span><span class="s1">'Node 3'</span><span class="p">,</span><span class="s1">'Node 4'</span><span class="p">,</span><span class="s1">'Node 5'</span><span class="p">,</span><span class="s1">'Node 6'</span><span class="p">,</span><span class="s1">'Node 7'</span><span class="p">,</span><span class="s1">'Node 8'</span><span class="p">)</span>
<span class="nb">title</span><span class="p">(</span><span class="s1">'Graph stabilization'</span><span class="p">,</span><span class="s1">'FontSize'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'Iterations'</span><span class="p">,</span><span class="s1">'FontSize'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s1">'States of the nodes'</span><span class="p">,</span><span class="s1">'FontSize'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://deustotech.github.io/DyCon-Blog/assets/imgs/WP99/P0001/copiaRM_03.png" alt="" /></p>

<p>We can see that the system is stabilized fast. One can tune the stabilization speed by choosing matrices $Q$ and $R$ in a smart way.</p>

<p>Now, we are about to add a reference term to the control to drive the system to a desired state. For instance, we can drive the system into the reference state</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">N</span><span class="p">)</span><span class="o">'</span><span class="p">;</span>
</code></pre></div></div>

<p>We add a reference term to the control that is proportional to the reference r, $u[k] = -K_{f}x[k] + K_{r}r$. We can use linear algebra to compute the matrix $K_{r}$ in terms of the system matrices.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Kr</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Kf</span> <span class="o">-</span> <span class="nb">eye</span><span class="p">(</span><span class="n">N</span><span class="p">))</span><span class="o">^</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span><span class="p">)</span><span class="o">^</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<p>We drive the system to the reference state.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">itmax</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">x</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">itmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">x</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">x_0</span><span class="p">;</span>
<span class="k">for</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">itmax</span>
    <span class="n">x</span><span class="p">(:,</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Kf</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Kr</span> <span class="o">*</span> <span class="n">r</span><span class="p">;</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">clf</span>
<span class="nb">hold</span> <span class="n">on</span>
<span class="k">for</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">N</span>
    <span class="nb">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">itmax</span><span class="p">,</span><span class="n">x</span><span class="p">(</span><span class="n">k</span><span class="p">,:),</span><span class="s1">'LineWidth'</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>
<span class="nb">legend</span><span class="p">(</span><span class="s1">'Node 1'</span><span class="p">,</span><span class="s1">'Node 2'</span><span class="p">,</span><span class="s1">'Node 3'</span><span class="p">,</span><span class="s1">'Node 4'</span><span class="p">,</span><span class="s1">'Node 5'</span><span class="p">,</span><span class="s1">'Node 6'</span><span class="p">,</span><span class="s1">'Node 7'</span><span class="p">,</span><span class="s1">'Node 8'</span><span class="p">)</span>
<span class="nb">title</span><span class="p">(</span><span class="s1">'Controlled graph'</span><span class="p">,</span><span class="s1">'FontSize'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'Iterations'</span><span class="p">,</span><span class="s1">'FontSize'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s1">'States of the nodes'</span><span class="p">,</span><span class="s1">'FontSize'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://deustotech.github.io/DyCon-Blog/assets/imgs/WP99/P0001/copiaRM_04.png" alt="" /></p>

<p>Assume now that we can control only the node 1 and we want to drive the node 8 to the reference state r = 1. Can we do it? Let’s see.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">B</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">B</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">C</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
<span class="n">C</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">if</span> <span class="nb">rank</span><span class="p">(</span><span class="n">ctrb</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">B</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">N</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'it is not controllable!'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>It is controllable.</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Q_diag</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_0</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
<span class="n">R_diag</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">/</span> <span class="mi">5</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>
<span class="n">Q</span> <span class="o">=</span> <span class="nb">diag</span><span class="p">(</span><span class="n">Q_diag</span><span class="p">);</span>
<span class="n">R</span> <span class="o">=</span> <span class="nb">diag</span><span class="p">(</span><span class="n">R_diag</span><span class="p">);</span>
<span class="p">[</span><span class="n">Kf</span><span class="p">,</span> <span class="o">~</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlqr</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="p">);</span>
<span class="n">Kr</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Kf</span> <span class="o">-</span> <span class="nb">eye</span><span class="p">(</span><span class="n">N</span><span class="p">))</span><span class="o">^</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span><span class="p">)</span><span class="o">^</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">itmax</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
<span class="n">x</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">itmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">x</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">x_0</span><span class="p">;</span>
<span class="k">for</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">itmax</span>
    <span class="n">x</span><span class="p">(:,</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Kf</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Kr</span> <span class="o">*</span> <span class="n">r</span><span class="p">;</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">clf</span>
<span class="nb">hold</span> <span class="n">on</span>
<span class="k">for</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">N</span>
    <span class="nb">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">itmax</span><span class="p">,</span><span class="n">x</span><span class="p">(</span><span class="n">k</span><span class="p">,:),</span><span class="s1">'LineWidth'</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>
<span class="nb">legend</span><span class="p">(</span><span class="s1">'Node 1'</span><span class="p">,</span><span class="s1">'Node 2'</span><span class="p">,</span><span class="s1">'Node 3'</span><span class="p">,</span><span class="s1">'Node 4'</span><span class="p">,</span><span class="s1">'Node 5'</span><span class="p">,</span><span class="s1">'Node 6'</span><span class="p">,</span><span class="s1">'Node 7'</span><span class="p">,</span><span class="s1">'Node 8'</span><span class="p">)</span>
<span class="nb">title</span><span class="p">(</span><span class="s1">'Driving node 8 to the state 1'</span><span class="p">,</span><span class="s1">'FontSize'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s1">'Iterations'</span><span class="p">,</span><span class="s1">'FontSize'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s1">'States of the nodes'</span><span class="p">,</span><span class="s1">'FontSize'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://deustotech.github.io/DyCon-Blog/assets/imgs/WP99/P0001/copiaRM_05.png" alt="" /></p>

<p>As we can see, the node 8 is driven to the state 1 by achieving consensus in all the states of the graph.</p>

<h2 id="references">References</h2>



                <hr>

            </div>
        </div>
    </div>
</article>


<hr>


    <!-- Footer -->
<footer>
  <hr>
  <div class="container">
    <div class="row">
      <ul class="list-inline text-center">
        <li>
          <img style="width: 200px;" src="/DyCon-Blog/img/logos/logo_DyCon.png " alt="">
        </li>
        <li style=" padding-bottom: 10px;">
          <img style="width: 250px;" src="/DyCon-Blog/img/logos/logo_CCM_subDerecha_v002.png " alt="">
        </li>
      </ul>
    </div>
  </div>
</footer>


</body>

</html>
